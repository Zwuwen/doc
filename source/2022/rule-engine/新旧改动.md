## 设备服务更改
### 设备知识管理
- 每个设备提供知识添加、删除、查询接口,设备根据自身属性和所具有的知识来产生事件上报给规则引擎和平台。
- 设备根据知识产生的事件格式如下
```json
{
    "productIdentifier": "D6_ZK_LC_6B11_J",
    "devSn": "dev1",
    "eventIdentifier": "lightOn",
    "params": {
        "onOff": 1
    }
}
```
- 目前每个设备的知识固化在xml文件中。格式如下
```xml
<?xml version="1.0" encoding="UTF-8"?>
<knowledge>
    <Universal>
        <unusualLighting>
            <name>异常照明事件</name>
            <propertyInfo>
                <property>brightness</property>
                <operator>IN</operator>
                <value>(0 20)</value>
            </propertyInfo>
        </unusualLighting>
        <energySavingLighting>
            <name>节能照明事件</name>
            <propertyInfo>
                <property>brightness</property>
                <operator>IN</operator>
                <value>[20 50)</value>
            </propertyInfo>
        </energySavingLighting>
        <normalLighting>
            <name>正常照明事件</name>
            <propertyInfo>
                <property>brightness</property>
                <operator>IN</operator>
                <value>[50 80)</value>
            </propertyInfo>
        </normalLighting>
        <highlightLighting>
            <name>高亮照明事件</name>
            <propertyInfo>
                <property>brightness</property>
                <operator>GTE</operator>
                <value>80</value>
            </propertyInfo>
        </highlightLighting>
        <lightOut>
            <name>关灯事件</name>
            <propertyInfo>
                <property>onOff</property>
                <operator>E</operator>
                <value>0</value>
            </propertyInfo>
        </lightOut>
        <lightOn>
            <name>开灯事件</name>
            <propertyInfo>
                <property>onOff</property>
                <operator>E</operator>
                <value>1</value>
            </propertyInfo>
        </lightOn>
    </Universal>
</knowledge>
```

### 定时策略
- 每个设备提供添加、删除定时策略的服务，定时策略的格式如下：
```json
{
  "rule": {
    "uuid": "1",
    "enable": 1,
    "date": {
      "startDate": "2022-09-26",
      "endDate": "2022-10-28"
    },
    "times": [
      {
        "startTime": "23:26:00",
        "endTime": "20:23:23",
        "params": {
          "onOff": 1,
          "brightness": 30
        }
      },
      {
        "startTime": "22:00:00",
        "endTime": "23:23:23",
        "params": {
          "onOff": 1,
          "brightness": 30
        }
      }
    ]
  }
}
```
- 自动模式下设备服务每分中检查一次定时策略，如果当前时间在某个定时策略的时间范围内，则向规则引擎发送定时开始事件,如果当前时间不在某个定时策略的时间范围内，则向规则引擎发送默认定时件，定时事件的格式如下：
```json
{
    "productIdentifier": "D6_ZK_LC_6B11_J",
    "devSn": "dev1",
    "eventIdentifier": "TIMER_START",
    "params": {
        "onOff": 80,
        "brightness": 50
    }
}
```
```json
{
    "productIdentifier": "D6_ZK_LC_6B11_J",
    "devSn": "dev1",
    "eventIdentifier": "TIMER_DEFAULT",
    "params": {
        "onOff": 1,
        "brightness": 100
    }
}
```
### 自动模式下的手动控制
- 设备在自动模式下,用户向设备服务发送业务指令，则设备服务会向规则引擎发送手动控制事件，事件格式如下：
```json
{
    "productIdentifier": "D6_ZK_LC_6B11_J",
    "devSn": "dev1",
    "eventIdentifier": "MANUAL_SERVICE",
    "params": {
        "brightness": 50
    }
}
```
## 规则引擎更改

### 联动规则管理
- 规则引擎提供规则的添加、删除、修改、查询服务，规则的格式如下：
```json
{
    "id": "test1",
    "name": "pedestrianCrossing",
    "description": "pedestrianCrossing",
    "priority": 51,
    "productIdentifier": "S8_RLY_RUILONJGS869",
    "devSn": "dev1",
    "active":"Y",
    "timeout":0,
    "eventIdentifier":"invade1",
    "conditions": [{
            "target": "onOff",
            "operator": "E",
            "comparison": "1"
        },{
            "target": "brightness",
            "operator": "E",
            "comparison": "2"
        }],
    "actions": [
        {
            "type": "CALL_SERVICE",
            "productIdentifier": "S5_HKDomeCamera",
            "devSn": "hk22000002",
            "params": "{ \"serviceIdentifier\": \"setOnOff\",\"serviceParams\": {\"onOff\": 1 }}"
        },      
        {
            "type": "CALL_SERVICE",
            "productIdentifier": "S3_KLT_C4",
            "devSn": "62711",
            "params": "{ \"serviceIdentifier\": \"setOnOff\",\"serviceParams\": {\"onOFF\": 1 }}"
        }
    ],
    "effectiveDate": {
        "startDate": "2022-09-15",
        "endDate": "2022-12-15",
        "startTime": "00:00:00",
        "endTime": "23:00:00"
    },
    "retryCount": 0
}
```
- 规则引擎固化一条定时策略用于匹配每个设备产生的定时事件,格式如下:
```json
 {
    "actions": [{
        "productIdentifier": "${productIdentifier}",
        "devSn": "${devSn}",
        "type": "CALL_SERVICE",
        "params": json.dumps({"coverByKnowledge": True, "serviceIdentifier": "do_timer_start"})}],
    "active": "Y",
    "conditions": [],
    "description": "",
    "eventIdentifier": "TIMER_START",
    "execUnit": "CLOUD",
    "identifier": "TIMER_START",
    "name": "设备定时开始事件",
    "priority": 50,
    "productIdentifier": "",
    "retryCount": 0,
    "timeout": 58,
    "effectiveDate": {
        "startDate": "1970-01-01",
        "endDate": "2070-01-01",
        "startTime": "00:00:00",
        "endTime": "23:59:59"
    },
    "id": "TIMER_START_RULE"
}
```
- 规则引擎固化一条临时手动策略用于匹配每个设备产生的手动事件,格式如下:
```json
     {
    "actions": [{
        "productIdentifier": "${productIdentifier}",
        "devSn": "${devSn}",
        "type": "CALL_SERVICE",
        "params": json.dumps({"coverByKnowledge": True, "serviceIdentifier": "${serviceIdentifier}"})
    }],
    "active": "Y",
    "conditions": [],
    "description": "",
    "eventIdentifier": "MANUAL_SERVICE",
    "execUnit": "CLOUD",
    "identifier": "MANUAL_SERVICE",
    "name": "手动控制",
    "priority": 100,
    "productIdentifier": "",
    "retryCount": 0,
    "timeout": 5 * 60,
    "effectiveDate": {
        "startDate": "1970-01-01",
        "endDate": "2070-01-01",
        "startTime": "00:00:00",
        "endTime": "23:59:59"
    },
    "id": "MANUAL_RULE"
}
```
- 规则引擎固化一条外部联动规则，用于匹配平台端所产生的事件，格式如下：
```json
 {
    "actions": [{
        "productIdentifier": "${productIdentifier}",
        "devSn": "${devSn}",
        "type": "CALL_SERVICE",
        "params": json.dumps({"coverByKnowledge": True, "serviceIdentifier": "${serviceIdentifier}"})
    }],
    "active": "Y",
    "conditions": [],
    "description": "",
    "eventIdentifier": "MANUAL_CONTROL",
    "execUnit": "CLOUD",
    "identifier": "MANUAL_CONTROL",
    "name": "外部控制",
    "priority": 100,
    "productIdentifier": "",
    "retryCount": 0,
    "timeout": 5,
    "effectiveDate": {
        "startDate": "1970-01-01",
        "endDate": "2070-01-01",
        "startTime": "00:00:00",
        "endTime": "23:59:59"
    },
    "id": "EXTERNAL_RULE"
}
```
### 规则执行
#### 定时策略
- 规则引擎在收到定时开始事件时,会根据当前设备执行策略的情况进行决策,如果当前设备所执行的联动策略的优先级大于等于定时策略的优先级(定时策略优先级固定为50)，则不执行定时策略，如果当前设备没有执行联动策略或执行的联动策略的优先级小于定时策略的优先级(50)，则执行定时策略。
- 规则引擎在收到定时默认事件时,会根据当前设备执行策略的情况进行决策,如果当前设备正在执行联动策略,则不执行定时策略，如果当前设备没有执行联动策略，则执行定时策略。
#### 手动控制
- 规则引擎在收到设备手动控制事件时,会根据打断当前设备所执行的策略,执行手动控制策略,手动控制策略的优先级最高(100),执行时间为5min。
#### 联动策略
- 规则引擎在收到设备根据自身知识产生的事件时,会进行规则匹配,如果匹配到联动策略,则进行规则优先级决策.打断当前设备所执行的低优先级策略或忽略执行当前匹配到的联动策略。